{% extends 'base.html' %}

{% block content %}
<h1>Тестирование торговой модели</h1>

<!-- Форма выбора данных для тестирования -->
<form id="data-selection-form" method="post">
    {% csrf_token %}
    <h2>Выберите данные для тестирования:</h2>
    {{ data_form.as_p }}
    <button type="submit">Выбрать данные</button>
</form>

<!-- Форма выбора сохраненной модели -->
<form id="model-selection-form" method="post" style="display: none;">
    {% csrf_token %}
    <h2>Выберите модель для тестирования:</h2>
    {{ model_form.as_p }}
    <button type="submit">Выбрать модель</button>
</form>

<!-- Блок для отображения графика и управления процессом -->
<div id="testing-section" style="display: none;">
    <h2>График тестирования</h2>
    <div id="chart-container">
        <div id="tradingview-chart"></div>
    </div>
    <button id="start-testing">Запустить процесс</button>
    <button id="stop-testing" disabled>Остановить процесс</button>
</div>

<script src="https://s3.tradingview.com/tv.js"></script>
<script>
    document.getElementById('data-selection-form').addEventListener('submit', function(e) {
        e.preventDefault();
        var form = this;

        // Отправка данных формы через AJAX для выбора данных
        var xhr = new XMLHttpRequest();
        xhr.open('POST', '{% url "select_data_for_testing" %}');
        xhr.setRequestHeader('X-CSRFToken', '{{ csrf_token }}');
        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
        xhr.responseType = 'json';
        xhr.onload = function() {
            if (xhr.status === 200) {
                var response = xhr.response;
                if (response.success) {
                    form.style.display = 'none';
                    document.getElementById('model-selection-form').style.display = 'block';
                } else {
                    alert('Ошибка: ' + JSON.stringify(response.errors));
                }
            } else {
                alert('Произошла ошибка при отправке данных.');
            }
        };
        xhr.onerror = function() {
            alert('Произошла ошибка при отправке запроса.');
        };
        xhr.send(new FormData(form));
    });

    document.getElementById('model-selection-form').addEventListener('submit', function(e) {
        e.preventDefault();
        var form = this;

        // Отправка данных формы через AJAX для выбора модели
        var xhr = new XMLHttpRequest();
        xhr.open('POST', '{% url "select_model_for_testing" %}');
        xhr.setRequestHeader('X-CSRFToken', '{{ csrf_token }}');
        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
        xhr.responseType = 'json';
        xhr.onload = function() {
            if (xhr.status === 200) {
                var response = xhr.response;
                if (response.success) {
                    console.log("Полученные данные:", response.data);
                    form.style.display = 'none';
                    document.getElementById('testing-section').style.display = 'block';
                    initializeTradingViewChart(response.data); // Передаем данные для графика
                } else {
                    alert('Ошибка: ' + JSON.stringify(response.errors));
                }
            } else {
                alert('Произошла ошибка при отправке данных.');
            }
        };
        xhr.onerror = function() {
            alert('Произошла ошибка при отправке запроса.');
        };
        xhr.send(new FormData(form));
    });

    function initializeTradingViewChart(data) {
    console.log("Полученные данные для графика:", data);

    new TradingView.widget({
        container_id: "tradingview-chart",
        width: "100%",
        height: 500,
        symbol: data.symbol, // Используем выбранный символ
        interval: data.interval, // Используем выбранный таймфрейм
        timezone: "Etc/UTC",
        style: "1",
        locale: "ru",
        toolbar_bg: "#f1f3f6",
        enable_publishing: false,
        allow_symbol_change: true,
        hide_side_toolbar: false,
        theme: "Light",
        datafeed: {
            onReady: function(callback) {
                callback({
                    supports_search: false,
                    supports_group_request: false,
                    supports_marks: false,
                    supports_timescale_marks: false,
                    supports_time: true
                });
            },
            resolveSymbol: function(symbolName, onSymbolResolvedCallback) {
                onSymbolResolvedCallback({
                    name: data.symbol,
                    timezone: "Etc/UTC",
                    minmov: 1,
                    pricescale: 100,
                    has_intraday: true,
                    supported_resolutions: ["1", "5", "15", "30", "60", "240", "D", "W"],
                    volume_precision: 2
                });
            },
            getBars: function(symbolInfo, resolution, from, to, onHistoryCallback) {
                var bars = data.bars.map(function(bar) {
                    return {
                        time: new Date(bar.timestamp).getTime(), // Преобразование в миллисекунды
                        low: parseFloat(bar.low_price),
                        high: parseFloat(bar.high_price),
                        open: parseFloat(bar.open_price),
                        close: parseFloat(bar.close_price),
                        volume: parseFloat(bar.volume)
                    };
                });
                onHistoryCallback(bars, { noData: bars.length === 0 });
            }

        }
    });
}

    document.getElementById('start-testing').addEventListener('click', function() {
        this.disabled = true;
        document.getElementById('stop-testing').disabled = false;
        // Начать тестирование: здесь вы можете добавить логику для начала процесса тестирования
        alert('Начинаем тестирование модели.');
    });

    document.getElementById('stop-testing').addEventListener('click', function() {
        this.disabled = true;
        document.getElementById('start-testing').disabled = false;
        // Остановить тестирование: здесь вы можете добавить логику для остановки процесса тестирования
        alert('Останавливаем тестирование модели.');
    });
</script>
{% endblock %}